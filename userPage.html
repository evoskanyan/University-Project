<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Page</title>
    <link rel="stylesheet" href="userPageStyle.css">
    <link rel="stylesheet" href="loginStyle.css">
</head>
<body>
<header>
    <div class="image-div">
        <img src="images/Capture.PNG" alt="logo" width="200">
    </div>
    <div class="user">

        <div class="user-info">
            <span id="welcome-user"> </span>
            <span id="welcome-user-mail"> </span>
            <span style="text-decoration: underline">No unread messages</span>

        </div>

        <div class="user-buttons">
            <button type="button" id="admin-button" onclick="action()"> Admin Settings</button>
            <button type="button" id="profile-button">Profile</button>
            <button type="button" id="signOut-button">Sign Out</button>
        </div>
    </div>

</header>

<nav>
    <div id="home" class="nav-link">
        <a href="" onclick="return false">Home</a>
    </div>
    <div class="nav-link">
        <a href="faculties.html">Faculties</a>
    </div>

    <div class="nav-link" id="classes">
        <a href="" onclick="return false">Classes</a>
    </div>

    <div id="student-information" class="nav-link">
        <a href="" onclick="return false">User Information</a>
    </div>

    <div id="password-change" class="nav-link">
        <a href="" onclick="return false">Change Password</a>
    </div>

</nav>

<section id="main-container">
    <div id="main-section">

        <div id="home-container">
            <img src="images/universtyPicture.jpg" alt="University"
                 style='height: 100%; width: 100%; object-fit: contain'>
        </div>


        <div id="fields-container">
            <h2>Change Password</h2>
            <div class="login-form-row ">
                <label for="oldPassword">Current Password</label>
                <input class="email" id="oldPassword" type="password" required>
            </div>

            <div class="login-form-row">
                <label for="newPassword">New Password</label>
                <input class="password" id="newPassword" type="password" required>
            </div>

            <div class="login-form-row">
                <label for="newPasswordRepeat">Confirm Password</label>
                <input class="password" id="newPasswordRepeat" type="password" required>
            </div>


            <div class="user-buttons">
                <button type="button" id="cancel-password-change">Cancel</button>
                <button type="button" id="save-password-change">Save</button>
            </div>
        </div>

        <div id="classes-container">

            <div id="classes-container-buttons">
                <div class="classes-container-buttons">
                    <button onclick="return false" id="classes-button-myLesson">MyLessons</button>
                    <button onclick="return false" id="classes-button-lessons">Lessons</button>
                    <button onclick="return false" id="classes-button-schedule">Schedule</button>
                </div>
            </div>

            <div id="classes-container-lessons">
                <table class="lessons" id="lessons">
                    <tr>
                        <th>Name</th>
                        <th>Credit</th>
                        <th>Time</th>
                        <th>Classroom</th>
                        <th></th>
                    </tr>
                </table>
            </div>

            <div id="classes-container-myLessons">
                <table class="lessons" id="myLessons">
                    <thead>
                    <tr>
                        <th>Class Name</th>
                        <th>Credit</th>
                        <th>Time</th>
                        <th>Classroom</th>
                    </tr>
                    </thead>
                </table>
            </div>

            <div id="classes-container-schedule">
                <table id="schedule">
                    <thead>
                    <tr>
                        <th>Week Day</th>
                        <th>Class Name</th>
                        <th>Credit</th>
                        <th>Time</th>
                        <th>Classroom</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div id="user-information-container">
            <div class="login-form-row ">
                <label for="fName">First Name</label>
                <input class="fName" id="fName" type="text" disabled>
            </div>

            <div class="login-form-row">
                <label for="newPassword">Last Name</label>
                <input class="password" id="lName" type="text" disabled>
            </div>

            <div class="login-form-row">
                <label for="newPasswordRepeat">Email</label>
                <input class="password" id="email" type="text" disabled>
            </div>


            <div class="login-form-row">
                <label for="gender">Gender</label>
                <input class="gender" id="gender" type="text" disabled>
            </div>

            <div class="login-form-row">
                <label for="faculty">Faculty</label>
                <input class="faculty" id="faculty" type="text" disabled>
            </div>

            <div class="login-form-row">
                <label for="bDay">Date of Birth</label>
                <input class="bDay" id="bDay" type="text" disabled>
            </div>

            <div class="user-buttons">
                <button type="button" id="edit-profile">Edit Profile</button>
                <button type="button" id="to-password-change">Change password</button>
            </div>

        </div>

        <div id="profileEdit-container">
            <div class="login-form-row ">
                <label for="newfName">First Name</label>
                <input class="newfName" id="newfName" type="text">
            </div>

            <div class="login-form-row">
                <label for="newlName">Last Name</label>
                <input class="newLname" id="newlName" type="text">
            </div>

            <div class="login-form-row">
                <label for="newEmail">Email</label>
                <input class="newEmail" id="newEmail" type="text">
            </div>


            <div class="login-form-row">
                <label for="newbDay">Date of Birth</label>
                <input class="newbDay" id="newbDay" type="date">
            </div>

            <div class="user-buttons">
                <button type="button" id="save-change">Save Changes</button>
                <button type="button" id="cancel-change">Cancel</button>
            </div>

        </div>
    </div>
</section>
<footer>
    <span>Copyright Â©2013-2022 American University of Armenia. All rights reserved.</span>
</footer>
<div id="after-footer">
</div>

<script>
    let fieldContainer = document.getElementById('fields-container');
    let userInfo = document.getElementById('user-information-container');
    let first = document.getElementById('home-container');
    let profileEdit = document.getElementById('profileEdit-container');
    let classesContainer = document.getElementById('classes-container');


    window.onload = function () {
        fieldContainer.style.display = "none";
        userInfo.style.display = "none";
        profileEdit.style.display = "none";
        classesContainer.style.display = "none";
        first.style.display = "block";
    }

    let signOutButton = document.getElementById('signOut-button');
    signOutButton.addEventListener('click', func);

    let users = JSON.parse(localStorage.getItem("users") || '[]');


    var currentUser;
    for (let i = 0; i < users.length; i++) {
        var user = users[i];
        if (user.login === true) {
            currentUser = user;
            if (user.isAdmin === false) {
                document.getElementById('admin-button').style.visibility = 'hidden';
            } else if (user.isAdmin === true) {
                console.log("is admin ,so button is visible")
                document.getElementById('admin-button').style.visibility = 'visible';
            }
            break;
        }
    }


    function action() {
        location.href = "adminPage.html";
    }

    let toChangePassword = document.getElementById("to-password-change");
    toChangePassword.addEventListener('click', toChangePasswordPage)

    function toChangePasswordPage() {
        userInfo.style.display = "none";
        first.style.display = "none";
        classesContainer.style.display = 'none';
        fieldContainer.style.display = "block";
    }

    let profileButton = document.getElementById('profile-button');
    profileButton.addEventListener('click', profile);

    function profile() {
        fieldContainer.style.display = 'none';
        classesContainer.style.display = "none";
        first.style.display = "none";
        let userInformation = document.getElementById('user-information-container');
        userInformation.style.display = 'inline-block ';
    }


    let cancelButton = document.getElementById('cancel-password-change');
    cancelButton.addEventListener("click", cancelPasswordChange)

    function cancelPasswordChange() {
        location.href = 'userPage.html';
    }

    let currentPassword = document.getElementById('oldPassword');
    let newPassword = document.getElementById('newPassword');
    let newPasswordRepeat = document.getElementById('newPasswordRepeat');

    let saveButton = document.getElementById('save-password-change');
    saveButton.addEventListener('click', savePasswordChange)

    function savePasswordChange() {
        if (currentPassword.value !== currentUser._password) {
            alert("Wrong current password specified")
        } else if (newPassword.value !== newPasswordRepeat.value || newPassword.value.length <= 0) {
            alert("Passwords are not the same or are not valid")
        } else {
            currentUser = changePassword(currentUser, newPassword.value)
            localStorage.setItem(`users`, JSON.stringify(currentUser));
            alert("Password successfully changed")
            setTimeout(goHome, 1000);
        }
    }


    document.getElementById('welcome-user').innerText = "Welcome, " + currentUser._fName;
    document.getElementById('welcome-user-mail').innerText = currentUser._email;


    function func() {
        for (let i = 0; i < users.length; i++) {
            if (users[i].login === true) {
                users[i].login = false;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }
        location.href = "login.html";
    }

    let studentInfo = document.getElementById('student-information');
    studentInfo.addEventListener('click', studentInformation)

    function studentInformation() {
        fieldContainer.style.display = 'none';
        first.style.display = "none"
        profileEdit.style.display = "none";
        classesContainer.style.display = 'none';
        let userInformation = document.getElementById('user-information-container');
        userInformation.style.display = 'inline-block ';
    }


    let home = document.getElementById('home')
    home.addEventListener('click', homePage)

    function homePage() {
        let fieldContainer = document.getElementById('fields-container');
        fieldContainer.style.display = "none";
        userInfo.style.display = "none";
        classesContainer.style.display = 'none';
        profileEdit.style.display = "none";
        first.style.display = "block"

    }

    let passwordChange = document.getElementById('password-change');
    passwordChange.addEventListener("click", passwordChangePage)

    function passwordChangePage() {
        userInfo.style.display = "none";
        profileEdit.style.display = "none";
        classesContainer.style.display = 'none';
        first.style.display = "none";
        fieldContainer.style.display = "block";

    }

    function changePassword(user, newPassword) {
        user._password = newPassword;
        return user;
    }

    function goHome() {
        location.href = "userPage.html";
    }

    document.getElementById("fName").value = currentUser._fName
    document.getElementById("lName").value = currentUser._lName
    document.getElementById("email").value = currentUser._email
    document.getElementById("gender").value = currentUser._gender
    document.getElementById("faculty").value = currentUser._faculty
    document.getElementById("bDay").value = currentUser._birthday


    let editProfileButton = document.getElementById('edit-profile');
    editProfileButton.addEventListener('click', editingProfile);

    function editingProfile() {
        userInfo.style.display = "none";
        classesContainer.style.display = "none";
        profileEdit.style.display = "block";
        first.style.display = "none";
        fieldContainer.style.display = "none";
    }

    let saveEditProfileButton = document.getElementById('save-change');
    saveEditProfileButton.addEventListener('click', savingEditedProfile);

    function savingEditedProfile() {
        let newFName = document.getElementById('newfName');
        let newLName = document.getElementById('newlName');
        let newEmail = document.getElementById('newEmail');
        let newBDay = document.getElementById('newbDay');
        if (checkLength(newFName.value) && checkLength(newLName.value) && checkLength(newBDay.value)
            && newEmail.validity.valid) {
            localStorage.removeItem(`users`);
            localStorage.setItem(`users`, JSON.stringify(changeProfile(newFName.value, newLName.value, newEmail.value, newBDay.value)));
            alert("Profile successfully edited")
            setTimeout(goHome, 1000);
        } else {
            alert("You need to fill all fields correctly")
        }
    }

    function changeProfile(fName, lName, email, bDay) {
        currentUser._fName = fName;
        currentUser._lName = lName;
        currentUser._email = email;
        currentUser._birthday = bDay;
        return currentUser;
    }

    function checkLength(str) {
        return str.length > 0;
    }

    let cancelChange = document.getElementById('cancel-change');
    cancelChange.addEventListener('click', cancelingChange);

    function cancelingChange() {
        setTimeout(goHome, 100);
    }

</script>

<script type="module">
    import {Lessons} from "./static/Classes.js";

    let buttons = document.getElementById("classes-container-buttons");
    let lessons = document.getElementById("classes-container-lessons");
    let myLessons = document.getElementById("classes-container-myLessons");
    let schedule = document.getElementById("classes-container-schedule");
    let lessonButton = document.getElementById("classes-button-lessons");
    let myLessonButton = document.getElementById("classes-button-myLesson");
    let scheduleButton = document.getElementById("classes-button-schedule");

    let classes = document.getElementById("classes");
    classes.addEventListener('click', callbackForClasses);

    function callbackForClasses() {
        fieldContainer.style.display = 'none';
        first.style.display = "none"
        profileEdit.style.display = "none";
        userInfo.style.display = "none";
        let classContainer = document.getElementById('classes-container');
        classContainer.style.display = 'block ';
        buttons.style.display = 'block';
        lessons.style.display = 'none';
        schedule.style.display = "none";
        myLessons.style.display = "block";
        callbackForMyLessons();
    }

    myLessonButton.addEventListener('click', callbackForMyLessons);

    function callbackForMyLessons() {
        lessons.style.display = "none";
        schedule.style.display = "none";
        myLessons.style.display = "block";
        let table = document.getElementById('myLessons');
        for (let i = 1; i < table.rows.length;) {
            table.deleteRow(i);
        }
        for (let currentUserLesson of currentUser._lessons) {
            table.append(createRowMyLessons(currentUserLesson));
        }
    }

    lessonButton.addEventListener('click', callbackForLessons);

    function callbackForLessons() {
        lessons.style.display = "block";
        myLessons.style.display = "none";
        schedule.style.display = "none";
    }

    scheduleButton.addEventListener('click', callbackForSchedule);

    function callbackForSchedule() {
        lessons.style.display = "none";
        myLessons.style.display = "none";
        schedule.style.display = "block";
        let table = document.getElementById("schedule");
        for (let i = 1; i < table.rows.length;) {
            table.deleteRow(i);
        }
        for (let j = 0; j < 5; j++) {
            for (let k = 0; k < currentUser._lessons.length; ++k) {
                if (k === 0) {
                    table.append(createRowSchedule(currentUser._lessons[k], weekdays[j]));
                } else {
                    table.append(createRowSchedule(currentUser._lessons[k], ""));
                }
            }
        }
    }

    let weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]


    let lessonsData = [];
    lessonsData.push(new Lessons('Matematika', 5, '09:00', '304W'));
    lessonsData.push(new Lessons('Matematika', 5, '10:05', '303W'));
    lessonsData.push(new Lessons('Matematika', 5, '11:10', '304E'));
    lessonsData.push(new Lessons('Matematika', 5, '12:15', '305W'));
    lessonsData.push(new Lessons('Matematika', 5, '13:20', '305W'));
    lessonsData.push(new Lessons('Fizika', 4, '09:00', '304E'));
    lessonsData.push(new Lessons('Fizika', 4, '10:05', '102W'));
    lessonsData.push(new Lessons('Fizika', 4, '11:10', '203W'));
    lessonsData.push(new Lessons('Fizika', 4, '12:15', '205E'));
    lessonsData.push(new Lessons('Fizika', 4, '13:20', '304W'));
    lessonsData.push(new Lessons('Informatika', 5, '09:00', '305W'));
    lessonsData.push(new Lessons('Informatika', 5, '10:05', '304W'));
    lessonsData.push(new Lessons('Informatika', 5, '11:10', '304W'));
    lessonsData.push(new Lessons('Informatika', 5, '12:15', '304W'));
    lessonsData.push(new Lessons('Informatika', 5, '13:20', '102W'));
    lessonsData.push(new Lessons('C++', 5, '09:00', '205E'));
    lessonsData.push(new Lessons('C++', 5, '10:05', '104W'));
    lessonsData.push(new Lessons('C++', 5, '11:10', '201E'));
    lessonsData.push(new Lessons('C++', 5, '12:15', '204W'));
    lessonsData.push(new Lessons('C++', 5, '13:20', '102E'));

    let addTo = [];
    for (let i = 0; i < lessonsData.length; i++) {
        addTo[i] = createCell(document.createElement("button"));
        addTo[i].innerHTML = "Add to my classes";
        addTo[i].setAttribute('onclick', "return false");
    }

    let i = 0;

    function createRowLessons(lesson) {
        let newRow = document.createElement('tr');
        newRow.append(createCell(lesson.name),
            createCell(lesson.credit),
            createCell(lesson.time),
            createCell(lesson.classroom),
            addTo[i]
        )
        ++i;
        return newRow;
    }


    function createCell(value) {
        let cell = document.createElement('td');
        cell.innerText = value;
        return cell;
    }

    for (let lessonsDatum of lessonsData) {
        document.getElementById("lessons").append(createRowLessons(lessonsDatum));
    }

    function createRowMyLessons(lesson) {
        let newRow = document.createElement('tr');
        newRow.append(createCell(lesson._name),
            createCell(lesson._credit),
            createCell(lesson._time),
            createCell(lesson._classroom))
        return newRow;
    }

    function createRowSchedule(lesson, weekday) {
        let newRow = document.createElement('tr');
        newRow.append(createCell(weekday),
            createCell(lesson._name),
            createCell(lesson._credit),
            createCell(lesson._time),
            createCell(lesson._classroom)
        )
        return newRow;
    }


    for (let j = 0; j < addTo.length; j++) {
        addTo[j].addEventListener('click', () => {

            for (let k = 0; k < currentUser._lessons.length; k++) {
                if (currentUser._lessons[k]._name === lessonsData[j]._name || currentUser._lessons[k]._time === lessonsData[j]._time) {
                    return alert("You can't choose this class")
                }
            }
            currentUser._lessons.push(lessonsData[j]);
            localStorage.setItem('users', JSON.stringify(users));
        })
    }

</script>

</body>
</html>